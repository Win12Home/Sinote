name: Sinote Editor Build and Package

on:
  push:
    branches: [ main ]
    paths:
      - '**.py'
      - '.github/workflows/**'
      - 'requirements.txt'
      - 'resources/plugins/**'
      - 'resources/language/**'
      - '!README.md'
      - '!documentation/**'
      - '!**.test.py'
      - '!resources/images/**'
      - '!resources/icon.png'
      - '!README/**'
      - '!.gitignore'
      - '!CHANGELOG.md'
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python Environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.14'
    
    - name: Install dependencies
      shell: bash
      run: |
        echo Upgrading PIP...
        python -m pip install --upgrade pip
        echo Upgraded successfully!
        echo Installing requirements and PyInstaller...
        pip install -r requirements.txt
        pip install pyinstaller
        echo Successfully to install!

    - name: Generate Entry File
      shell: bash
      run: |
        echo Generating entry of Window...
        cat > sets.py << EOF
        from core.excepthook import setExceptionHook
        from core.addons.asciiOutput import asciiOutput
        from utils.verChecker import verChecker
        def setEntry() -> None:
            verChecker()
            setExceptionHook()
            asciiOutput()
        cat > EntryWindow.py << EOF
        from utils.sinoteScript import appStart
        from sets import setEntry
        setEntry()
        appStart(silent=True)
        EOF
        echo Generated!
        echo Generating entry of Console...
        cat > EntryConsole.py << EOF
        from utils.sinoteScript import appStart
        from sets import setEntry
        # Note: This is not needed, but it's readability.
        appStart(silent=False)
        EOF
        echo Generated!
    
    - name: Build Application Binary File (Included GUI&Consoled)
      shell: bash
      run: |
        echo Starting parallel build...
        pyinstaller --onedir --windowed --exclude-module unittest --exclude-module PySide6.QtQuick --exclude-module PySide6.QtMultimedia --exclude-module PySide6.QtBluetooth EntryWindow.py --name Sinote --icon ./resources/icon.png &
        pyinstaller --onedir --console --exclude-module unittest --exclude-module PySide6.QtQuick --exclude-module PySide6.QtMultimedia --exclude-module PySide6.QtBluetooth EntryConsole.py --name Sinote_Consoled --icon ./resources/icon.png &
        wait
        echo Finished application generate

    - name: Create flat directory structure
      shell: bash
      run: |
        mkdir -p bin
        echo Made ./bin directory!
        echo Operating...
        if [ -d "dist/Sinote_Consoled" ]; then
          mv dist/Sinote_Consoled/* ./bin -n
        fi
        if [ -d "dist/Sinote" ]; then
          mv dist/Sinote/* ./bin -n
        fi
        
        echo Operate Successfully!
        
        echo Copying resources...
        cp -r resources bin/
        echo Copied!
        
        echo Copying GitHub File
        cp README.md bin/ 2>/dev/null || echo "README.md not found, skipping"
        cp LICENSE bin/ 2>/dev/null || echo "LICENSE not found, skipping"
        cp -r 3rd-party-license bin/ 2>/dev/null || echo "3rd-party-license not found, skipping"
        cp -r README bin/ 2>/dev/null || echo "README not found, skipping"
        cp CHANGELOG.md bin/ 2>/dev/null || echo "CHANGELOG.md not found, skipping"
        echo Copied Successfully!
        echo Directory of Binaries
        ls -la "./bin"

    - name: Compile Sinote CLI and add into Binary folder
      shell: bash
      run: |
        echo Compiling Sinote CLI...
        rm -rf dist
        pyinstaller -F -c --exclude PySide6 --exclude tkinter --exclude qt_material --exclude PIL --exclude psutil -i ./resources/images/plugins.png SinoteCLI.py -n SinoteCLI
        cp ./dist/* ./bin
        echo Compiled Sinote CLI!
        

    - name: Create version info file
      shell: bash
      run: |
        echo Creating Version Information...
        if [ "${{ github.event_name }}" != "pull_request" ]; then
          cat > bin/VERSION.txt << EOF
        Sinote Editor
        Version: official @ ${{ github.sha }}
        Build Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        Platform: ${{ runner.os }}
        Build Type: Dual Mode (GUI + Console)
        EOF
        else
          cat > bin/VERSION.txt << EOF
        Sinote Editor (Unofficial, PR)
        PR Number: PR # ${{ github.event.number }}
        Build Date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
        Platform: ${{ runner.os }}
        Build Type: Dual Mode (GUI + Console)
        
        NOTICE: Pull Request Action is not a official generation.
        EOF
        fi  
        echo Successfully to create!
        echo Final Directory
        ls -la "./bin"

    - name: Set build file name
      id: set_build_type
      shell: bash
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "BUILD_SUFFIX=pr-${{ github.event.number }}-unofficial" >> $GITHUB_OUTPUT
        else
          echo "BUILD_SUFFIX=${{ github.ref_name }}-${{ github.sha }}-official" >> $GITHUB_OUTPUT
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Sinote-${{ runner.os }}-${{ steps.set_build_type.outputs.BUILD_SUFFIX }}
        path: bin/
